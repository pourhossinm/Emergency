<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Video Conference</title>-->
<!--</head>-->
<!--<body>-->
<!--    <h1>Video Call</h1>-->
<!--    <video id="localVideo" autoplay playsinline></video>-->
<!--    <video id="remoteVideo" autoplay playsinline></video>-->

<!--    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>-->
<!--    <script>-->
<!--        const socket = io();-->
<!--        const localVideo = document.getElementById('localVideo');-->
<!--        const remoteVideo = document.getElementById('remoteVideo');-->
<!--        let localStream;-->
<!--        let peerConnection;-->
<!--        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };-->

<!--        async function start() {-->
<!--            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });-->
<!--            localVideo.srcObject = localStream;-->
<!--            socket.emit("join");  // اعلام حضور به سرور-->
<!--        }-->

<!--        socket.on("start_call", async () => {-->
<!--            peerConnection = new RTCPeerConnection(config);-->
<!--            peerConnection.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };-->
<!--            peerConnection.onicecandidate = (event) => { if (event.candidate) socket.emit("candidate", event.candidate); };-->
<!--            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));-->

<!--            const offer = await peerConnection.createOffer();-->
<!--            await peerConnection.setLocalDescription(offer);-->
<!--            socket.emit("offer", offer);-->
<!--        });-->

<!--        socket.on("offer", async (offer) => {-->
<!--            if (!peerConnection) {-->
<!--                peerConnection = new RTCPeerConnection(config);-->
<!--                peerConnection.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };-->
<!--                peerConnection.onicecandidate = (event) => { if (event.candidate) socket.emit("candidate", event.candidate); };-->
<!--                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));-->
<!--            }-->
<!--            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));-->
<!--            const answer = await peerConnection.createAnswer();-->
<!--            await peerConnection.setLocalDescription(answer);-->
<!--            socket.emit("answer", answer);-->
<!--        });-->

<!--        socket.on("answer", async (answer) => {-->
<!--            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));-->
<!--        });-->

<!--        socket.on("candidate", async (candidate) => {-->
<!--            if (peerConnection) {-->
<!--                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));-->
<!--            }-->
<!--        });-->

<!--        start();-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Chat</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>WebRTC Audio and Video Chat</h1>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        let localStream;
        let peerConnection;
        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // Get local media stream
        async function getLocalStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
            } catch (err) {
                console.error('Error accessing media devices.', err);
            }
        }

        // Create a peer connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            peerConnection.addEventListener('icecandidate', handleIceCandidate);
            peerConnection.addEventListener('track', handleTrackEvent);

            // Add local stream tracks to peer connection
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        // Handle ICE candidate event
        function handleIceCandidate(event) {
            if (event.candidate) {
                socket.emit('message', { type: 'candidate', candidate: event.candidate });
            }
        }

        // Handle incoming remote track
        function handleTrackEvent(event) {
            const remoteStream = event.streams[0];
            document.getElementById('remoteVideo').srcObject = remoteStream;
        }

        // Create an offer
        async function createOffer() {
            createPeerConnection();
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('message', { type: 'offer', offer: offer });
        }

        // Handle incoming messages from Socket.IO
        socket.on('message', async (message) => {
            if (message.type === 'offer') {
                createPeerConnection();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('message', { type: 'answer', answer: answer });
            } else if (message.type === 'answer') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
            } else if (message.type === 'candidate') {
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        });

        // Start the video chat
        getLocalStream().then(() => {
            createOffer();
        });
    </script>
</body>
</html>
